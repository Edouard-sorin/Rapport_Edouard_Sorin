
# Résultats
## Influence du lieu d'échantillonnage et des variétés sur le spectre de réflectance global

Dans un premier temps, il est intéressant d'observer les données brutes des spectres de réflectance en fonction de leurs variétés.
La figure 2.1 montre les spectres de réflectance moyens des variétés citron (en vert), tangor (en orange) et zanzibar (en violet) (figure \@ref(fig:19)).

```{r 19, fig.cap="Spectre moyen en fonction de la variété pour les arbres négatifs aux HLB"}

data_long_var <- data_long_Ed
data_SPIR_var <- data_SPIR_Ed
masque_qPCR <- data_SPIR_var$qPCR_36 == 0
data_SPIR_var <- data_SPIR_var[masque_qPCR,]

g3 <- ggplot(data_long_var) +
  aes(x = lambda, y = reflectance, group = code_variete, color = code_variete ) +
  stat_summary(fun = mean, geom = "line" , size = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "Longueur d'onde (en nm)", y = "Réflectance moyenne", color = "Variété") +
  dark_theme_gray() +
  theme(legend.position = "bottom")

g3
```

Les spectres des variétés échantillonnées ne semblent pas avoir de comportements significativement différents suivant les variétés sur l'ensemble des longueurs d'onde. L'analyse de ces données brutes ne suffit donc pas à renseigner sur l'influence que peuvent avoir les variétés sur les spectres du statut HLB.

Le calcul du F de Fisher via l’ANOVA est donc mis en œuvre afin de montrer un effet potentiel du lieu d’échantillonnage et des variétés sur le spectre de réflectance global (figure \@ref(fig:x)).

```{r x, fig.cap = "Valeur du F de Fisher pour chaque longueur d’onde montrant l’influence du facteur variété sur le spectre de réflectance global"}

data_long_agri <- data_long_Ed

data_long.lambda <- split(data_long_agri, data_long_agri$lambda)

model.lm <- lapply(data_long.lambda, function(x) lm(reflectance ~ code_variete ,data = x))

model.anov<-lapply(model.lm, function(x) anova(x))

# Pour annalyser l'anova en tant que tel, chercher dans l'anova pour la lougueur d'onde souhaité

intermed.anov <- as.data.frame(do.call(rbind, model.anov))

intermed.anov2 <- intermed.anov[,(which(colnames(intermed.anov) == "F value" ):which(colnames(intermed.anov) == "Pr(>F)"))]

Anov_Discrim <- intermed.anov2[ !is.na(intermed.anov2),]

rownames(Anov_Discrim ) = 0:4301

Anov_Discrim  <- Anov_Discrim [(which(rownames(Anov_Discrim ) == 0 ):which(rownames(Anov_Discrim ) == 2150)),]

colnames(Anov_Discrim) <- c("F_value","P_value")

Anov_Discrim $lambda <- as.numeric(350:2500)

## Graphique de présentation ####

gx <- ggplot(Anov_Discrim) +
  
  geom_line(aes(x = lambda , y = F_value) , colour = "#FFFF00") +
  
  labs(x = "Longueur d'onde (en nm)", y = "F_value", color = "") +
  
  dark_theme_gray() +
  
  theme(panel.grid.major.y = element_line(colour = "grey20")) +
  
  annotate(geom = "text", x = Anov_Discrim$lambda[(which.max(Anov_Discrim$F_value))], y = 9+Anov_Discrim$F_value[(which.max(Anov_Discrim$F_value))], label = Anov_Discrim$lambda[(which.max(Anov_Discrim$F_value))], size = 4, colour = "red")+
  
  geom_point(aes(x = Anov_Discrim$lambda[(which.max(Anov_Discrim$F_value))], y = 2+Anov_Discrim$F_value[(which.max(Anov_Discrim$F_value))] ), shape = 124, fill="darkred" ,color = "red" , size = 2) 

gx
```

\vfill
\newpage
L’influence des variétés sur les spectres de réflectance est importante à partir de 1400nm avec un maximum à 1420nm (valeur F = 230). Ce maximum est suivi de deux autres pics à F = 200 à 1800nm et 2300nm, tous compris dans la partie du spectre correspondant aux infrarouges courtes longueurs d'onde.

Concernant l'influence de la parcelle sur le spectre de réflectance global, celle-ci a une forte influence (figure \@ref(fig:y)).

```{r y, fig.cap = "Valeur du F de Fisher pour chaque longueur d’onde montrant l’influence du facteur parcelle sur le spectre de réflectance global"}

data_long_agri <- data_long_Ed

data_long.lambda <- split(data_long_agri, data_long_agri$lambda)

model.lm <- lapply(data_long.lambda, function(x) lm(reflectance ~ code_agri,data = x))

model.anov<-lapply(model.lm, function(x) anova(x))

# Pour annalyser l'anova en tant que tel, chercher dans l'anova pour la lougueur d'onde souhaité

intermed.anov <- as.data.frame(do.call(rbind, model.anov))

intermed.anov2 <- intermed.anov[,(which(colnames(intermed.anov) == "F value" ):which(colnames(intermed.anov) == "Pr(>F)"))]

Anov_Discrim <- intermed.anov2[ !is.na(intermed.anov2),]

rownames(Anov_Discrim ) = 0:4301

Anov_Discrim  <- Anov_Discrim [(which(rownames(Anov_Discrim ) == 0 ):which(rownames(Anov_Discrim ) == 2150)),]

colnames(Anov_Discrim) <- c("F_value","P_value")

Anov_Discrim $lambda <- as.numeric(350:2500)

## Graphique de présentation ####

gy <- ggplot(Anov_Discrim) +
  
  geom_line(aes(x = lambda , y = F_value), colour = "#228B22") +
  
  labs(x = "Longueur d'onde (en nm)", y = "F_value", color = "") +
  
  dark_theme_gray() +
  
  theme(panel.grid.major.y = element_line(colour = "grey20")) +
  
  annotate(geom = "text", x = Anov_Discrim$lambda[(which.max(Anov_Discrim$F_value))], y = 9+Anov_Discrim$F_value[(which.max(Anov_Discrim$F_value))], label = Anov_Discrim$lambda[(which.max(Anov_Discrim$F_value))], size = 4, colour = "red")+
  
  geom_point(aes(x = Anov_Discrim$lambda[(which.max(Anov_Discrim$F_value))], y = 2+Anov_Discrim$F_value[(which.max(Anov_Discrim$F_value))] ), shape = 124, fill="darkred" ,color = "red" , size = 2) 

gy

```

Dans le "Red edge" avec un maximum à 771nm (valeur F = 875) et une influence qui reste assez élevé (autour de F = 625) autour des longueurs d'onde 1500nm et 2100nm.

\vfill
\newpage
## Effet du statut HLB sur les spectres de réflectance

La répartition des différentes variétés dans le jeu de données en fonction de leurs statuts HLB est assez équilibrée (table \@ref(tab:T1)).

```{r T1, eval=T, echo = FALSE}

sum_var_36 <- ftable ( code_variete + qPCR_36 ~ code_ech_arbre, data = data_SPIR_Ed)

sum_var_36 <- as.matrix(sum_var_36)

Citron.Negatif <- sum(sum_var_36[1:length(levels(data_SPIR_Ed$code_ech_arbre)),1])/60

Citron.Positif <- sum(sum_var_36[1:length(levels(data_SPIR_Ed$code_ech_arbre)),2])/60

Tangor.Negatif <- sum(sum_var_36[1:length(levels(data_SPIR_Ed$code_ech_arbre)),3])/60

Tangor.Positif <- sum(sum_var_36[1:length(levels(data_SPIR_Ed$code_ech_arbre)),4])/60

Zanzibar.Negatif <- sum(sum_var_36[1:length(levels(data_SPIR_Ed$code_ech_arbre)),5])/60

Zanzibar.Positif <- sum(sum_var_36[1:length(levels(data_SPIR_Ed$code_ech_arbre)),6])/60

Total <- length(levels(data_SPIR_Ed$code_ech_arbre))

Total_all_Var <- rbind(Citron.Negatif,Citron.Positif,Tangor.Negatif,Tangor.Positif,Zanzibar.Negatif,Zanzibar.Positif,Total)

knitr::kable((Total_all_Var), caption="Répartition des variétés dans le jeu de données", longtable = TRUE, booktabs = TRUE, escape = FALSE) %>%
kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE) 

```

La figure 2.4 montre les spectres de réflectance moyens des arbres positifs au HLB (en rouge) et des arbres négatifs (en vert). On voit des différences nettes de spectre en fonction du statut HLB (figure \@ref(fig:16)).

```{r 16, fig.cap="Spectre moyen en fonction du statut HLB des arbres"}

library(ggplot2) #ggplot pour graphiques
library(ggdark) # graphique noir

g0 <- ggplot(data_long_Ed) +
  aes(x = lambda, y = reflectance, group = qPCR_36, color = factor(qPCR_36) ) +
  stat_summary(fun = mean, geom = "line", size = 0.5) +
  scale_color_brewer(palette = "Dark2", labels = c("Négatif","Positif")) +
  labs(x = "Longueur d'onde (en nm)", y = "Reflectance moyenne", color = "Resultat du test HLB a Ct<36") +
  dark_theme_gray() +
    theme(legend.position = "bottom")
  
g0

 
```

Sur certaines parties du spectre des différences de réflectance apparaissent encore plus nettement (figure \@ref(fig:17)).

```{r 17, fig.cap="Spectres individuels d’arbres positifs (en rouge) et négatifs (en vert) au HLB pour les longueurs d'onde de 400 à 680 nm"}

# graph moyennes a CT 36 zoome sur les spectres 400 a 680 nm #####

g1 <- ggplot(data_long_Ed[data_long_Ed$lambda >= 400 & data_long_Ed$lambda <= 680,] ) +
  aes(x = lambda, y = reflectance, group = code_ech_arbre, color = qPCR_36 )+
  stat_summary(fun = mean, geom = "line", size = 0.5) +
  scale_color_manual(values = c('0' = "darkgreen", '1' = "brown4")) +
  labs(x = "Longueur d'onde (en nm)", y = "Reflectance moyenne")+
  dark_theme_gray() +
theme(legend.position = "none")

g1

```

Sur les longueurs d’onde de 400 à 680 nm les arbres positifs au HLB ont une réflectance légèrement plus élevée que les arbres sains. 

Par ailleurs, une séparation moins nette s'observe dans la tranche de longueurs d'onde comprise entre 700 et 1400 nm (figure \@ref(fig:18)).

```{r 18, fig.cap="Spectres individuels d’arbres positifs (en rouge) et négatifs (en vert) au HLB pour les longueurs d’onde de 700 à 1400 nm"}
## graph moyennes a CT 36 zoome sur les spectres 700 a 1400 nm  ####

g2 <- ggplot(data_long_Ed[data_long_Ed$lambda >= 700 & data_long_Ed$lambda <= 1400,] ) +
  aes(x = lambda, y = reflectance, group = code_ech_arbre, color = qPCR_36 )+
  stat_summary(fun = mean, geom = "line", size = 0.5) +
  scale_color_manual(values = c('0' = "darkgreen", '1' = "brown4")) +
  labs(x = "Longueur d'onde (en nm)", y = "Reflectance moyenne") +
  dark_theme_gray()  +
  theme(legend.position = "none")

g2

```

La différence qui paraissait importante sur la figure 2.1 est à nuancer si l'on s'intéresse aux spectres individuels. En effet, il ne semble pas se dégager de tendance claire vis à vis du statut sur cette partie du spectre. 

C'est pourquoi il est difficile d'affirmer avec certitude l'effet de la maladie sur les spectres de réflectance en fonction du statut HLB en utilisant seulement les données brutes.

Ainsi, il est intéressant de savoir s'il y a une influence de la maladie sur les spectres de réflectance et sur quelles longueurs d'onde se situe cet effet (figure \@ref(fig:21)).

```{r 21, fig.cap = "Valeur du F de Fisher montrant l’influence du statut seul en interaction avec la variété sur le spectre de réflectance"}

data_long_agri <- data_long_Ed

data_long.lambda <- split(data_long_agri, data_long_agri$lambda)

model.lm <- lapply(data_long.lambda, function(x) lm(reflectance ~ qPCR_36 * code_variete * code_agri ,data = x))

model.anov<-lapply(model.lm, function(x) anova(x))

# Pour analyser l'anova en tant que tel, chercher dans l'anova pour la lougueur d'onde souhaité

intermed.anov <- as.data.frame(do.call(rbind, model.anov))

intermed.anov2 <- intermed.anov[,(which(colnames(intermed.anov) == "F value" ):which(colnames(intermed.anov) == "Pr(>F)"))]

Anov_Discrim <- intermed.anov2[ !is.na(intermed.anov2),]

nrow_anov <- nrow(Anov_Discrim)

rownames(Anov_Discrim)<- 0:(nrow_anov-1)

Anov_Discrim  <- Anov_Discrim [(which(rownames(Anov_Discrim) == 0 ):which(rownames(Anov_Discrim) == ((2151*6)-1))),]

colnames(Anov_Discrim) <- c("F_value","P_value")

Anov_Discrim$lambda <- as.numeric(rep (350:2500 , each = 6))

Anov_Discrim$Anov_by <- factor(rep(c("Statut seul","Influence variete","Influence parcelle","variété x statut","parcelle x statut","variété x parcelle"),each=1)) 

rm(data_long_agri,data_long.lambda,model.anov,model.lm,intermed.anov,intermed.anov2,trueP)

select.influ_statut <- grep("Statut seul", Anov_Discrim$Anov_by )

select.influ_var <- grep("variété x statut", Anov_Discrim$Anov_by )

select.influ_agri <- grep("parcelle x statut", Anov_Discrim$Anov_by )

Anov_statut <- Anov_Discrim[c(select.influ_statut,select.influ_var,select.influ_agri),]

## Graphique Relation statut seul ###

g5 <- ggplot(Anov_statut) +
  aes(x = lambda, y = F_value, colour = Anov_by) +
  geom_line() + 
  labs(x = "Longueur d'onde (en nm)", y = "F_value", color = "Influence de") +
  
  dark_theme_gray() +
  
  scale_colour_manual(values = c("#228B22","#4876FF","#FFFF00"))+
  
  theme(panel.grid.major.y = element_line(colour = "grey20")) +
  
    annotate(geom = "text", x = Anov_statut$lambda[(which.max(Anov_statut$F_value))], y = 30+Anov_statut$F_value[(which.max(Anov_statut$F_value))], label = Anov_statut$lambda[(which.max(Anov_statut$F_value))], size = 4, colour = "red")+
  
  geom_point(aes(x = Anov_statut$lambda[(which.max(Anov_statut$F_value))], y = 5+Anov_statut$F_value[(which.max(Anov_statut$F_value))] ), shape = 124, fill="darkred" ,color = "red" , size = 2) +
  
  theme(legend.position = "bottom") 

g5

```

Globalement le statut HLB affecte le spectre de réflectance dans trois zones du spectre : dans le début du “Red edge” autour de 700nm, dans le proche infra-rouge autour de 800nm et dans le “Short-wave infrared” autour de 2000 nm avec un pic à 2032nm (valeur F = 751). Les effets du statut sont influencés dans le “Red edge” et le proche infra-rouge par le type de variété sur laquelle les feuilles ont été prélevées. Cependant le pic de cette influence correspond à une zone où la valeur de Fisher est quasi nulle pour l’effet du statut sur la détection de la maladie par la réflectance. Cette influence des variétés est donc comprise entre les valeurs de Fisher de 200 à 150 en excluant la zone de creux. Ces valeurs sont assez faibles si on les compare aux effets du statut qui avoisine les 700 et plus. Les trois variétés ont donc un impact plutôt faible sur la détection de la maladie via la mesure de la réflectance. Cet impact est encore plus minime (valeur F = 30) au niveau du pic d’influence de la maladie à 2032nm correspondant à la quantité d’eau dans la feuille. Cet impact est encore plus faible pour l’influence de la parcelle sur le statut HLB. Celle-ci n’a qu’une très faible influence sur le statut HLB au niveau des spectres dans visible et le “Red edge” (valeur F = 98) et une influence quasi nulle dans les autres longueurs d’onde 

\vfill
\newpage
## L'approche par arbre de décision

Une autre approche pour mettre en évidence l'effet du statut sur la détection de la maladie par la réflectance est la représentation en arbres de décision (figure \@ref(fig:22)).

```{r 22, eval = TRUE, fig.cap = "Arbre de décision sur la réflectance des données globales par rapport au statut HLB", fig.width = 9, fig.height = 9, fig.align = 'center'}

library(party)  # Plot l'arbre de decision en Random Forest

library(tidyr) # pivot longer & pivot wider

library(ggplot2)
library(ggparty)
library(ggdark)

seuil.ct = 36

intermed.arbre <- aggregate(reflectance ~ code_ech_feuille + qPCR_36 + lambda, data =  data_long_Ed, mean)

mean.arbre <- pivot_wider(intermed.arbre, names_from = "lambda", values_from = "reflectance", names_prefix = "X")

RF_ct <- mean.arbre
RF_ct <- round(RF_ct[, grep("^X", names(RF_ct))],3)
masque_numeric <- sapply(RF_ct, is.numeric)
RF_ct <- RF_ct[,masque_numeric]
RF_ct[,paste0("qPCR_", seuil.ct)] <- mean.arbre[,paste0("qPCR_", seuil.ct)]


gtree_glob <- ctree( qPCR_36 ~ . , data=RF_ct)


rf.ct <- ggparty(gtree_glob, terminal_space = 0.2 , horizontal = F) +  # terminal_space =  taille aloué aux plots (terminal)
  
geom_edge(colour = "grey77", size = 0.5) + # mettre reflectance
  
 geom_edge_label(colour = c("black") , size = 4 , alpha = 0.1) +
  
  geom_node_label(# map color of complete label to splitvar
    mapping = aes(),
    # map content to label for each line
    line_list = list(aes(label = splitvar),
                     aes(label = paste("p =",
                                       formatC(p.value,
                                               format = "e",
                                               digits = 2))),
                     aes(label = ""),
                     aes(label = paste0("Nœud ", id," N = ", nodesize))
    ),
    # set graphical parameters for each line in same order
    line_gpar = list(list(size = 12),
                     list(size = 10),
                     list(size = 6),
                     list(size = 8,
                          col = "black",
                          fontface = "bold",
                          alignment = "left")
    ),
    # only inner nodes
    ids = "inner") +
  
  geom_node_label(aes(label = paste0("Nd ", id," N = ", nodesize), size = 2), 
                  fontface = "bold",
                  ids = "terminal",
                  size = 3.7,
                  nudge_y = 0.023)+

  geom_node_plot(gglist = list(geom_bar(aes(x = "" , fill = qPCR_36),
                                        position = position_fill(),
                                        alpha = 0.8),
                               theme_classic(base_size = 15) ,
                               scale_fill_brewer(palette = "Dark2"),xlab("")),
                 shared_axis_labels = TRUE, # Met 1 legende pour tous les plots
                 legend_separator = TRUE, # trait entre la legende et les plots
                 size = 1.2,
                 height = 1) +
  
  theme_void() 

rf.ct

```

Cette autre approche apporte des résultats identiques à la valeur de Fisher sur les longueurs d'onde où le statut HLB a le plus d'influence. Le premier nœud de décision à la longueur d'onde 2000nm est très significatif (p value 1.32e-36) et se divise entre les zones du "Red edge" à 706nm pour 774 feuilles et du proche-infra rouge à 1075nm pour les 666 feuilles restantes. Sur les 774 feuilles du deuxième nœud (p value 9.71e-18), 572 sont des feuilles issues d'arbres négatifs aux HLB à plus de 75% environ en additionnant la part des effectifs négatifs des nœuds 6 et 7. Par ailleurs sur les 666 feuilles du nœud 9 (p value 4.84e-9), 333 sont globalement issus d'arbres positifs aux HLB à plus de 75% environ en additionnant la part des effectifs positifs des nœuds 10 et 13. Cela montre qu'il est possible d'identifier depuis le spectre de réflectance, les arbres sains et malades avec un taux d'erreur d'environ 75%. 
L'intérêt de cette méthode en plus de donner les longueurs d'onde discriminantes pour la maladie, est la valeur de réflectance pour laquelle chaque longueur d'onde discriminante est clivante.


Enfin, en prenant uniquement la longueur d'onde la plus clivante (2000nm) selon l'arbre de décision, il est possible de se rendre compte de l’hétérogénéité des distributions à l'intérieur de celle-ci (figure \@ref(fig:23)).

```{r 23, eval = TRUE, fig.cap = "Distribution des réflectances la longueur d’onde 2000nm"}

X2000 <- data_SPIR_Ed[,c(which(colnames(data_SPIR_Ed) == "X2000"),which(colnames(data_SPIR_Ed) == "code_variete"),which(colnames(data_SPIR_Ed) == "code_agri"),which(colnames(data_SPIR_Ed) == "qPCR_36"))]

h1 <- ggplot(X2000) +
  aes(x = X2000, fill = qPCR_36, colour = code_variete) +
  labs(x = "Réflectance (sans unité)", y = "Effectif des valeurs de Réflectance", color = "Variété")+
  geom_histogram(bins = 30L) +
  scale_fill_hue(l = 50 , h = c(150,20), labels = c("Négatif","Positif") , name = "Statut HLB") + 
  xlim(0.04, 0.15) +
  scale_colour_manual(values = c("#00EEEE","#FFFF00","#0000CD"))+
  dark_theme_gray() +
  theme(legend.position = "bottom") +
  facet_wrap(vars(code_agri))

h1

```

\vfill
\newpage
Malgré l'échantillonnage différent selon les parcelles, les valeurs de réflectance sont normalement distribuées bien que centrées différemment. Chez Barret et Pothin, le centre est quasiment sur 0.09 alors que chez Gonthier et Hoarau celui-ci est environ à 0.07. Concernant les variétés, les Zanzibars semblent avoir les valeurs de réflectances les moins élevés. Malgré cette hétérogénéité dans la répartition des variables, qui est quasiment identique pour toutes les autres longueurs d'onde, cela n'a finalement pas un énorme impact sur la discrimination de la réflectance en fonction du statut.

\vfill
\newpage
## Comparaison des performances des 3 méthodes de prédiction du statut HLB à partir des spectres réflectance

Pour prédire le statut des arbres à partir des spectres de réflectance, les trois méthodes d'analyses statistiques en apprentissage supervisé sont mises en œuvre. Pour chacune de ces méthodes, les paramètres de performance sont mesurés (table \@ref(tab:T2)) après 100 simulations en calculs parallèles présentés en annexes 2 et 3.

```{r T2}

load("All_parametre_36.Rdata")

ML.36$critere <- c("Accuracy PLS","Accuracy RF","Accuracy SVM","Precision PLS","Precision RF","Precision SVM","Sensitivity PLS","Sensitivity RF","Sensitivity SVM")

colnames(ML.36) <- c("Paramètres de performance","Moyenne" ,"Ecart type")

knitr::kable((ML.36), caption="Paramètres de performance du statut HLB par Régression par les Moindres Carrés Partiels", longtable = TRUE, booktabs = TRUE , digits = 1, escape = FALSE) %>%
kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE)

```

Au vu de ces simulations, la méthode de régression par les moindres carrés partiels (PLS) est la plus robuste avec une qualité de prédiction (Accuracy) avoisinant les 92.6% et avec l'écart type le plus faible d'environ 1.7.
Cette méthode est aussi très robuste pour minimiser les erreurs de type 1 (précision à 97.2%) et de type 2 (sensibilité à 88.3%) avec là aussi des écarts types plus faible que les deux autres méthodes.
Vient ensuite la méthode de la machine à vecteurs de support (SVM) avec une qualité de prédiction (Accuracy) d'environ 85.8% et avec l'écart type le plus élevé avoisinant les 2.7. La méthode des forêts aléatoires (RF) est la moins robuste avec une qualité de prédiction (Accuracy) de 76.4% approximativement.

\vfill
\newpage
## Prédiction du statut HLB par Régression par les Moindres Carrés Partiels (PLS)

Concrètement, en utilisant la meilleure méthode, qui est celle des moindres carrés partiels, le statut des arbres peut donc être prédit précisément  (figure \@ref(fig:24)).

```{r 24, fig.cap = "Prédiction du statut HLB par Régression par les Moindres Carrés Partiels"}


# Library ####

library(caTools) # sample.split

# Usage de l'algorithme partial least square

library(pls) # Fonction Partial Least Square

# Mise en forme des donnees 
library(tidyr) # transformation du format des donnees : pivot_longer
library(tidyverse)#faciliter l'installation et le chargement de plusieurs paquets "tidyverse"

library(ggplot2) # Package ggplot pour graphiques
library(ggdark) # Met un style de graphique ggplot en noir


# Prediction a partir du training set et du test set a ct36 ####

nb.rep <- 6
seuil.ct <- 36

set.seed(1)  # Pour la reproductibilité

Tirage <- split(data_SPIR_Ed, data_SPIR_Ed$code_ech_feuille, drop = T)


maliste <- lapply(Tirage,function(feuille){ 
  list_pls <- feuille[sample(1:length(feuille$code_ech_feuille), nb.rep),]  
  # on fait ça pour tte les feuilles mais tjrs en choisissant le nombre de rep tire aleatoirement
  code <- grep("^code_ech", names(list_pls))
  qPCR <- grep("^qPCR_", names(list_pls))
  sortie <- cbind.data.frame(unique(list_pls[c(code,qPCR)])
                             , matrix(apply(list_pls[-(which(colnames(list_pls) == "code_variete"):which(colnames(list_pls) == "qPCR_36"))], 2, mean)
                                      , nr = 1, dimnames = list(NULL, names(list_pls)[-(which(colnames(list_pls) == "code_variete"):which(colnames(list_pls) == "qPCR_36"))])))
  sortie
})

test_ed <- do.call(rbind, maliste) # on colle toute les listes créées précédement 

test_ed <- test_ed[-(which(colnames(test_ed) == "qPCR_32"))]

test_ed[[paste0("qPCR_", seuil.ct)]] <- as.numeric(as.character(test_ed[[paste0("qPCR_", seuil.ct)]] ))

decoup <- sample.split(test_ed[,paste0("qPCR_", seuil.ct)], SplitRatio = 0.75) # on decoupe le jeu de donné en training set et test set

train_pls <- test_ed[decoup,]
test_pls <- test_ed[!decoup,] 

model_pls_36 <-  plsr(
  
  train_pls[[paste0("qPCR_", seuil.ct)]] ~ . ,
  data = train_pls[, grep("^X", names(train_pls))], 
  scale = TRUE, 
  validation = "CV"
  
)

# Prediction

pls_pred <- test_pls

# Prediction sur les feuilles de la base d'apprentissage

pls_pred$pls_pred_36 <- predict(model_pls_36, newdata = test_pls[, grep("^X", names(test_pls))], decision.values = T, ncomp=100)

# Conversion des resultats de la prediction en numerique

pls_pred$pls_pred_36 = as.numeric(as.character(pls_pred$pls_pred_36))

# Re arrangemant des donnees

select.lambda <- grep("^X", names(pls_pred))
pls_pred <- pls_pred[,c(names(pls_pred)[-select.lambda], names(pls_pred)[select.lambda] )]

# Moyennage des resultats de la prediction pour chaque arbres

pls_pred_arbres_36 = aggregate(pls_pred_36 ~ code_ech_arbre, data = pls_pred, mean, na.rm = T)

pls_pred_arbres_36$pls_pred_36[pls_pred_arbres_36$pls_pred_36 < 0] = 0   # Pour enlever les valeurs négatives

# Critere choisi sur les observations graphiques

crit.pos <- 0.4
crit.neg <- 0.35

# Parametrage pour presentation graphique et la matrice de confusion

pls_pred_arbres_36$statut_pred <- "Indéterminé"
pls_pred_arbres_36$statut_pred[pls_pred_arbres_36$pls_pred_36 >= crit.pos  ] <- "Positif"
pls_pred_arbres_36$statut_pred[pls_pred_arbres_36$pls_pred_36 <= crit.neg  ] <- "Négatif"

pls_pred_arbres_36$crit <- 0.5
pls_pred_arbres_36$crit[pls_pred_arbres_36$pls_pred_36 >= crit.pos  ] <- 1
pls_pred_arbres_36$crit[pls_pred_arbres_36$pls_pred_36 <= crit.neg  ] <- 0

# Creation d'une nouvelle colonne des resulats issu de la qPCR, pour comparer à la valeurs predite

trueP$seuil.32 <- NULL

pls_pred_arbres_36[paste("qPCR", seuil.ct, sep = "_")] <- lapply(trueP, function(x)
  as.numeric(pls_pred_arbres_36$code_ech_arbre %in% x ))

# Résultats de la prédiction sous forme de matrice de confusion 

pls_pred_arbres_36$crit <- factor(pls_pred_arbres_36$crit ,levels= c(0,1))

pls_confusion_matrix_36 <- ftable( qPCR_36 ~ crit , data = pls_pred_arbres_36 )

pls_confusion_matrix_36 <- as.matrix(pls_confusion_matrix_36)

TP <- pls_confusion_matrix_36[1,1]

TN <- pls_confusion_matrix_36[2,2]

FN <- pls_confusion_matrix_36[2,1]

FP <- pls_confusion_matrix_36[1,2]

#pls_confusion_matrix_36

# Calcul des parametres pls de la matrice de confusion

Accuracy_pls36 <- ((TP+TN) / (TP+TN+FN+FP)*100)

Precision_pls36 <- ((TP / (TP+FP)*100))

Sensitivity_pls36 <- ((TP / (TP+FN)*100))

Parametre_pls_36 <- rbind(Accuracy_pls36,Precision_pls36,Sensitivity_pls36)


rownames(Parametre_pls_36) <- c("Accuracy","Precision","Sensitivity")

pls_pred_arbres_36$Pred.correct = "Négatif"
pls_pred_arbres_36$Pred.correct[pls_pred_arbres_36$code_ech_arbre %in% trueP$seuil.36] = "Positif"

# Organiser resultat dans un tableau à 4 cases avec Vrai postif, Vrai négatif , Faux positif, Faut négatif

g6 <- ggplot(pls_pred_arbres_36)+
  aes(y = pls_pred_36 , x = code_ech_arbre, color = statut_pred) +
  geom_rect(aes(xmin = "A1", xmax = "T7", ymin = crit.neg, ymax = crit.pos), lwd = 1 , fill = "gray50", color = "gray50") +
  geom_point(aes(shape = Pred.correct, size = Pred.correct), fill ="blue") + 
  scale_size_manual(values =c(2.1,2.9) ,name = "Statut Confirmé")+
  scale_shape_manual(values =c(4,21),name = "Statut Confirmé")+
  geom_segment(aes(xend = code_ech_arbre, y = 0, yend = pls_pred_36)) +
  scale_color_manual(values = c(Négatif = "green", Indéterminé = "gray20", Positif = "red")) +
  labs(x = "Code de l'arbre", y = "Résultat moyen des feuilles entre 0 et 1", color = "Statut Prédit") +  dark_theme_gray() +
  theme(legend.position = "bottom") 

g6

```

Cette représentation graphique est une aide à la décision afin de connaître le degré de précision de la prédiction sur chaque arbre. La prédiction par PLS donne une valeur correspondant à la moyenne des statuts prédits (compris entre 0 et 1 en ordonnés) des dix feuilles d'un arbre pour chaque arbre (en abscisse). Cela indique pour chaque arbre s'il est plutôt positif ou négatif, mais ça ne permet pas de trancher sur le statut de l'arbre. Cette prédiction se base donc sur deux seuils choisis via les observations de prédiction effectuées. Ces seuils sont compris entre 0.4 pour les arbres positifs qui seraient au-dessus de cette valeur (en rouge), 0.35 pour les arbres négatifs qui serait en dessous de cette valeur (en vert) et les arbres indéterminés (en gris) qui seraient compris entre ces deux valeurs. Une comparaison entre le statut réel des arbres est confirmé par qPCR (avec un croix pour les négatifs et un rond pour les positifs), permet ensuite de réaliser la matrice de confusion (table \@ref(tab:T3))

\vfill
\newpage

```{r T3}

colnames(pls_confusion_matrix_36) <- c("Négatif confirmé","Positif confirmé")
rownames(pls_confusion_matrix_36) <- c("Négatif prédit","Positif prédit")

knitr::kable((pls_confusion_matrix_36), caption="Matrice de confusion de la méthode de Régression par les Moindres Carrés Partiels", longtable = TRUE, booktabs = TRUE, escape = FALSE) %>%
kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE)

```

Sur cette prédiction, 62 arbres ont été prédits correctement positifs et 57 correctement négatifs. 10 arbres ont été prédits comme faussement positif (erreur de type 1) et 2 comme faussement négatif (erreur de type 2).

```{r T4}
knitr::kable((Parametre_pls_36), caption="Paramètres de performance du statut HLB par Régression par les Moindres Carrés Partiels", longtable = TRUE, booktabs = TRUE, digits = 1, escape = FALSE) %>%
kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

La prédiction par la méthode de régression par PLS a l'avantage d'avoir une précision élevée (96.6%) ce qui minimise les erreurs de type 2, ce qui est très utile pour l'identification de la maladie sur une parcelle (table \@ref(tab:T4)).

\vfill
\newpage
## Amélioration du protocole de terrain pour le choix du nombre de feuilles par arbre

La méthode de la SVM est la méthode dont l’estimation des performances est la plus rapide à exécuter. Elle est donc utilisée pour tester s’il est possible d’alléger le protocole d’échantillonnage (figure \@ref(fig:25)).

```{r 25, fig.cap = "Prédiction des paramètres de SVM en fonction du nombre de feuilles échantillonnés sur chaque arbre, obtenu après avoir fait la moyenne de 1000 SVM"}

data_rep_feuille.36 <- read.table(file = "Param_SVM_nb_feuille_ct36_1000_simu.csv"
                           , header = T
                           , sep = ";"
                           , stringsAsFactors = T
                           , row.names = 1
                           , na.strings = c("","NA")
                           , dec = "." )



g7<- ggplot(data = data_rep_feuille.36) +
  aes(x = nb.rep, y = valeurs, color = critere, group = critere)+
  stat_summary(geom = "pointrange", fun.data = function(x) mean_se(x, mult = qt(0.975, length(x) - 1))) +
  stat_summary(geom = "line", fun = mean) +
  scale_x_continuous(breaks=seq(1:10)) +  
  labs(x = "Nombre de feuilles échantillonnées sur chaque arbre", y = "Valeurs moyennes", color = "Paramètres de performance en SVM") +
  dark_theme_gray() +
  theme(legend.position = "bottom")+
  scale_colour_viridis_d() +
  theme(panel.grid.major.y = element_line(colour = "grey20"))

g7

```

Après 1000 simulations, les paramètres de performance de la méthode SVM sont respectivement de 95% pour la précision (Precision), 96% pour la sensibilité (Sensitivity) et 97% pour la qualité globale de la prédiction (Accuracy) pour un échantillonnage de 10 feuilles. La précision et la sensibilité passent en dessous des 90% avec 5 feuilles prélevées. Avec 8 feuilles échantillonnées la qualité de la prédiction ainsi que la sensibilité ne baissent pas en dessous de 95%.

\vfill
\newpage
## Amélioration du protocole de terrain pour le choix du nombre de mesures de réflectance par feuille

```{r 26, fig.cap = "Prédiction des paramètres de SVM en fonction du nombre de répétition SPIR par feuille échantillonnés sur chaque arbre, obtenu après avoir fait la moyenne de 100 SVM" }


load("SVM_ct36_6rep_100simu_18_02.Rdata")

g8 <- ggplot(data = data_global.36) +
  aes(x = nb.rep, y = valeurs, color = critere, group = critere)+
  stat_summary(geom = "pointrange", fun.data = function(x) mean_se(x, mult = qt(0.975, length(x) - 1))) +
  stat_summary(geom = "line", fun = mean) +
  scale_x_continuous(breaks=seq(1:6)) +  
  labs(x = "Nombre de mesures SPIR effectuées sur chaque feuille", y = "Valeurs moyennes", color = "Paramètres de performance en SVM") +
  dark_theme_gray() +
  theme(legend.position = "bottom")+
  scale_colour_viridis_d() +
  theme(panel.grid.major.y = element_line(colour = "grey20"))

g8

```

Après 100 simulations, les paramètres de performances de la méthode SVM sont respectivement de 85% pour la sensibilité (Sensitivity), 82% pour la qualité globale de la prédiction (Accuracy)  et 81% pour la précision (Precision) pour un passage de 6 répétitions SPIR (figure \@ref(fig:26)). Les écarts types étant assez marqués, au bout de 3 répétitions SPIR les paramètres de performance sont très peu changeants.

\vfill
\newpage
# Discussion

Au vu des résultats, de part une valeur F de Fisher élevée (plus de 500 en moyenne), le lieu d'échantillonnage semble avoir un influence significative sur les valeurs de réflectance de 750 à 2500nm (figure \@ref(fig:x)). Dans une moindre mesure, la variété à aussi une influence sur les valeurs de réflectance de 1400 à 2500nm avec une valeur F de Fisher de 150 en moyenne (figure \@ref(fig:y)). Aucun de ces deux paramètres ne semble affecter les longueurs d'onde dans le visible de 350 à 700nm et les effet des variétés et du lieu d'échantillonnage sur le statut sont assez négligeable sur cette zone et dans l'infrarouge courte longueur d'onde (de 1400 à 2500nm).
Le statut seul a donc une influence sur cette partie du spectre avec une influence modérée des variétés et du lieu d'échantillonnage (figure \@ref(fig:21)). Ainsi, dans le visible et le début du “Red edge”, cette influence peut s’expliquer par une moins bonne absorbance de la lumière par la chlorophylle des feuilles à cause de la maladie. 
Dans le proche infra-rouge autour de 800nm le statut a aussi une influence importante sur la réflectance avec en parallèle une influence importante du lieu d'échantillonnage sur cette partie du spectre (figure \@ref(fig:y)). 
Le proche infra-rouge correspondant à la structure interne de la feuille a un effet sur le spectre de réflectance global dû à la maladie. En effet, le HLB affect la structure cellulaire et en particulier celle du phloème, là où la bactérie se développe. Celle-ci va entraîner des nécroses et obstruer les vaisseaux. Ces dégradations vont donc altérer la réflectance de la lumière de cette partie de la feuille ce qui se voit lors de l'analyse des spectres.
Pour finir, c'est dans l'infrarouge courte longueur d'onde autour de 2000nm que s'observe la plus grande valeur F de Fisher (figure \@ref(fig:21)) mais c'est aussi une zone du spectre où le lieu d'échantillonnage (figure \@ref(fig:y)) et les variétés (figure \@ref(fig:x)) dans une moindre mesure ont un effet sur la réflectance globale. L'effet du statut sur cette zone peut s’expliquer par une moins bonne absorbance de la lumière par la chlorophylle des feuilles en lien avec la maladie (figure \@ref(fig:17)).
L'effet du statut sur cette zone peut s’expliquer par le fait que le HLB affecte grandement l'alimentation en eau de la feuille par l'obstruction des vaisseaux [@bove_huanglongbing_2006].

En plus de l'approche par la variance via l'ANOVA, l'approche par arbre de décision a permis de mettre en évidence d'une autre manière les longueurs d'onde discriminantes les plus clivantes. Ainsi, au vu de ces deux approches pour détecter plus facilement la maladie, 3 tranches de longueurs d'onde sont à favoriser, autour de 700nm, 1000nm et 2000nm (figure \@ref(fig:22)). Ces longueurs d'onde trouvées sont similaires à celles présentes dans la documentation pour la détection du HLB [@mishra_spectral_2007].

La réalisation d'un modèle de prédiction du statut HLB par arbres à partir du spectre de réflectance s’est révélée être pertinente à bien des égards.
Le modèle de prédiction a permis de connaître l'état sanitaire des arbres via 3 méthodes d'analyse des spectres de réflectance. Ces 3 méthodes ont des qualités de prédiction (Accuracy) qui varie de 92.6% pour la méthode PLS à 85.8% et 76.4% pour la méthode SVM et RF (table \@ref(tab:T2)). Ces valeurs sont là  aussi proches de celles présentes dans la bibliographie concernant la qualité de la prédiction avec 85% pour SVM dans l'article de Sindhuja Sankaran [@sankaran_huanglongbing_2013] et 96.4% pour PLS dans l'article de Xiaoling Deng [@deng_detection_2020].
La méthode PLS étant la meilleure, elle permet de minimiser les erreurs de type 2 pour une meilleure identification de la maladie sur les parcelles (table \@ref(tab:T2)).  Cela peut s'expliquer dans la mesure où l’un des principaux intérêts de l'algorithme PLS est d’augmenter en performance et en fiabilité proportionnellement avec l’augmentation du nombre de variables explicatives permettant de prédire les composantes du modèle. C'est donc la méthode PLS qui est à favoriser pour les prédictions du statut HLB.

\vfill
\newpage
Finalement, cette étude confirme le haut potentiel qu’offre l’utilisation de la Spectroscopie Proche Infrarouge via une classification par PLS et SVM avec une approche orientée à la feuille pour la caractérisation de l'infection au HLB.
Cette caractérisation est possible grâce aux seuils de décision trouvés. Ces 2 seuils sont de 0.4 et plus pour les arbres malades à 0.35 et moins pour les arbres sains avec une classe indéterminée entre ces deux seuils.
Ces analyses ont aussi permis d'améliorer le protocole de terrain en préconisant un échantillonnage minimal de 8 feuilles par arbres (figure \@ref(fig:25)) et 3 répétitions SPIR par feuille (figure \@ref(fig:26)) pour un bon compromis entre le temps d'échantillonnage et la précision du modèle. L’utilisation de la proxidétection dans la surveillance du HLB doit tout de même être couplée à un travail de terrain avec analyse en qPCR pour la validation du statut des arbres.

Le modèle de prédiction réalisée dans ce rapport pourra, à terme, être utilisé comme un outil de détection décisif dans l’amélioration de surveillance épidémiologique du Huanglongbing (HLB) à La Réunion. Surtout si le modèle est alimenté avec de nouveaux échantillons dans le but d'agrandir la base d'apprentissage. En effet, ce modèle est pour l'instant valable uniquement pour 3 variétés d'agrumes sur les 27 que compte la Réunion. Afin d'optimiser ce modèle, il serait intéressant de l'enrichir avec d'avantage de variétés sur des lieux d'échantillonnages différents. Cela permettrait de répéter les analyses effectuées en comparant les résultats et les performances des différentes méthodes d'apprentissage supervisés testés pour améliorer le modèle.

# Conclusion

Face à la résurgence actuelle du HLB à la Réunion, le potentiel d’un diagnostic HLB par SPIR, à la fois rapide que les analyses en laboratoire et peu onéreux est prometteur. 

La construction de ce modèle de détection permettra de prédire le statut HLB des arbres sur différentes parcelles et d’en évaluer l’efficacité. Ce modèle permettra d’accentuer l’effort de surveillance sur les foyers de production les plus à risque où un échantillonnage qPCR classique n’est pas envisageable à grande échelle au regard des ressources disponibles. 
Le modèle pouvant déterminer assez précisément quels arbres sont infectés au HLB au sein d’une parcelle, cela permettra d'accompagner au mieux les agriculteurs dans la lutte contre la maladie.

Ainsi, prédire le statut HLB des parcelles d’agrumes par apprentissage supervisé est une solution prometteuse bien que la base de données d’apprentissage doit être étoffée pour garantir une prédiction plus juste à long terme.